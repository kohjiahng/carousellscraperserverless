org: jiahng
app: carousell-discord-scraper
service: CarousellDiscordScraper
frameworkVersion: "3"
useDotenv: true

provider:
  name: aws
  runtime: nodejs20.x
  region: ap-southeast-1
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - sns:Publish
          Resource: !Ref CommandTopic
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:DeleteItem
            - dynamodb:Scan
          Resource:
            - !GetAtt RequestTable.Arn
            - !GetAtt ListingTable.Arn
            - !GetAtt WebhookTable.Arn
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource: "*"

package:
  individually: true

functions:
  proxyLambda:
    handler: proxylambda/index.handler
    environment:
      COMMAND_TOPIC_ARN: !Ref CommandTopic
    package:
      patterns:
        - "!./**"
        - proxylambda/**

  startHandler:
    handler: starthandler/index.handler
    environment:
      REQUEST_TABLE_ARN: !Ref RequestTable
      WEBHOOK_HANDLER_ARN: !GetAtt WebhookHandlerLambdaFunction.Arn
    package:
      patterns:
        - "!./**"
        - starthandler/**
        - handlerpackage/**
    events:
      - sns:
          arn: !Ref CommandTopic
          topicName: CommandTopic
          filterPolicy:
            command:
              - start

  statusHandler:
    handler: statushandler/index.handler
    environment:
      REQUEST_TABLE_ARN: !Ref RequestTable
    package:
      patterns:
        - "!./**"
        - statushandler/**
        - handlerpackage/**
    events:
      - sns:
          arn: !Ref CommandTopic
          topicName: CommandTopic
          filterPolicy:
            command:
              - status

  stopHandler:
    handler: stophandler/index.handler
    environment:
      REQUEST_TABLE_ARN: !Ref RequestTable
    package:
      patterns:
        - "!./**"
        - stophandler/**
        - handlerpackage/**
    events:
      - sns:
          arn: !Ref CommandTopic
          topicName: CommandTopic
          filterPolicy:
            command:
              - stop

  idScraperLambda:
    handler: idscraperlambda/index.handler
    environment:
      LISTING_TABLE_ARN: !Ref ListingTable
    package:
      patterns:
        - "!./**"
        - idscraperlambda/**

  scraperProxy:
    handler: scraperproxy/index.handler
    environment:
      REQUEST_TABLE_ARN: !Ref RequestTable
      ID_SCRAPER_ARN: !GetAtt IdScraperLambdaLambdaFunction.Arn
    package:
      patterns:
        - "!./**"
        - scraperproxy/**
    # events:
    #   - schedule: rate(1 minute)

  webhookHandler:
    handler: webhookhandler/index.handler
    environment:
      WEBHOOK_TABLE_ARN: !Ref WebhookTable
      DISCORD_BOT_TOKEN: ${env:TOKEN}
    package:
      patterns:
        - "!./**"
        - webhookhandler/**
  listingHandler:
    handler: listinghandler/index.handler
    events:
      - stream:
          type: dynamodb
          arn: !GetAtt ListingTable.StreamArn
          batchSize: 8
    package:
      patterns:
        - "!./**"
        - listinghandler/**

resources:
  Resources:
    CommandTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: CarousellDiscordScraperCommandTopic

    ProxyLambdaInvoker:
      Type: AWS::IAM::User
      Properties:
        UserName: "ProxyLambdaInvoker"
        Policies:
          - PolicyName: ProxyLambdaInvokePolicy
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - "lambda:InvokeFunction"
                  Resource: !GetAtt ProxyLambdaLambdaFunction.Arn

    ProxyLambdaInvokerUserKey:
      Type: AWS::IAM::AccessKey
      Properties:
        UserName:
          Ref: ProxyLambdaInvoker

    RequestTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: CarousellDiscordScraperRequestTable
        AttributeDefinitions:
          - AttributeName: channel_id
            AttributeType: S
        KeySchema:
          - AttributeName: channel_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    ListingTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: CarousellDiscordScraperListingTable
        AttributeDefinitions:
          - AttributeName: channel_id
            AttributeType: S
          - AttributeName: listing_id
            AttributeType: S
        KeySchema:
          - AttributeName: channel_id
            KeyType: HASH
          - AttributeName: listing_id
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        StreamSpecification:
          StreamViewType: NEW_IMAGE
    WebhookTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: CarousellDiscordScraperWebhookTable
        AttributeDefinitions:
          - AttributeName: channel_id
            AttributeType: S
        KeySchema:
          - AttributeName: channel_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

outputs:
  ProxyLambdaInvokerAccessKeyID: !Ref ProxyLambdaInvokerUserKey
  ProxyLambdaInvokerSecretAccessKey: !GetAtt ProxyLambdaInvokerUserKey.SecretAccessKey
  ProxyLambdaArn: !GetAtt ProxyLambdaLambdaFunction.Arn
